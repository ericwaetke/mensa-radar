import { useEffect, useLayoutEffect, useRef, useState } from "react"
// import { supabase } from "../../lib/getSupabaseClient"

const ratingSVG = (rating: string, userRating: number) => {
	if(rating === userRating.toString()) {
		switch(rating) {
			case "1":
				return (<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 29 30" className="transform rotate-180 w-8 h-8">
							<path d="M.94 20.18c0 1.38.26 2.65.78 3.81a7.02 7.02 0 0 0 2.14 2.77 4.9 4.9 0 0 0 3.09 1.04h2.71a7.92 7.92 0 0 1-2.83-3.34c-.58-1.34-.88-2.8-.88-4.4a11.72 11.72 0 0 1 1.4-5.71c.39-.72.77-1.33 1.15-1.83H6.44a4.3 4.3 0 0 0-2.82 1.03 6.79 6.79 0 0 0-1.96 2.75 10.04 10.04 0 0 0-.72 3.88Zm6.73-.11a8.47 8.47 0 0 0 2.81 6.46 9.66 9.66 0 0 0 3.33 1.9c1.3.46 2.75.69 4.38.69h1.9c.9 0 1.69-.03 2.34-.09A8.27 8.27 0 0 0 24 28.8a3.97 3.97 0 0 0 1.48-.73c.45-.36.67-.86.67-1.53 0-.27-.03-.5-.1-.7a2.2 2.2 0 0 0-.22-.53c-.12-.2-.1-.33.08-.4.43-.18.81-.47 1.12-.86.32-.39.47-.86.47-1.4 0-.64-.16-1.17-.5-1.59-.16-.22-.12-.4.14-.54.3-.18.56-.46.76-.82a2.91 2.91 0 0 0 .13-2.2c-.1-.3-.24-.55-.41-.71-.19-.17-.17-.35.06-.55.2-.18.37-.43.5-.73a2.6 2.6 0 0 0-.12-2.28c-.22-.38-.5-.68-.88-.9a2.28 2.28 0 0 0-1.23-.33H21c-.61 0-1.12-.15-1.5-.44-.39-.3-.58-.72-.58-1.23 0-.47.12-1.02.35-1.66.24-.63.51-1.3.82-2 .32-.72.59-1.43.82-2.13a6.4 6.4 0 0 0 .36-2c0-.65-.19-1.15-.56-1.5A1.85 1.85 0 0 0 19.36.5c-.51 0-.91.15-1.2.47-.29.3-.57.73-.84 1.26a36.24 36.24 0 0 1-3.47 5.53 598.25 598.25 0 0 0-3.5 4.59c-.6.79-1.1 1.57-1.5 2.34a9.9 9.9 0 0 0-.89 2.45c-.2.86-.3 1.83-.3 2.93Z" fill="#43BC63"/>
						</svg>)
			case "2":
				return (<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 29 30" className="transform -rotate-90 w-8 h-8">
							<path d="M.94 20.18c0 1.38.26 2.65.78 3.81a7.02 7.02 0 0 0 2.14 2.77 4.9 4.9 0 0 0 3.09 1.04h2.71a7.92 7.92 0 0 1-2.83-3.34c-.58-1.34-.88-2.8-.88-4.4a11.72 11.72 0 0 1 1.4-5.71c.39-.72.77-1.33 1.15-1.83H6.44a4.3 4.3 0 0 0-2.82 1.03 6.79 6.79 0 0 0-1.96 2.75 10.04 10.04 0 0 0-.72 3.88Zm6.73-.11a8.47 8.47 0 0 0 2.81 6.46 9.66 9.66 0 0 0 3.33 1.9c1.3.46 2.75.69 4.38.69h1.9c.9 0 1.69-.03 2.34-.09A8.27 8.27 0 0 0 24 28.8a3.97 3.97 0 0 0 1.48-.73c.45-.36.67-.86.67-1.53 0-.27-.03-.5-.1-.7a2.2 2.2 0 0 0-.22-.53c-.12-.2-.1-.33.08-.4.43-.18.81-.47 1.12-.86.32-.39.47-.86.47-1.4 0-.64-.16-1.17-.5-1.59-.16-.22-.12-.4.14-.54.3-.18.56-.46.76-.82a2.91 2.91 0 0 0 .13-2.2c-.1-.3-.24-.55-.41-.71-.19-.17-.17-.35.06-.55.2-.18.37-.43.5-.73a2.6 2.6 0 0 0-.12-2.28c-.22-.38-.5-.68-.88-.9a2.28 2.28 0 0 0-1.23-.33H21c-.61 0-1.12-.15-1.5-.44-.39-.3-.58-.72-.58-1.23 0-.47.12-1.02.35-1.66.24-.63.51-1.3.82-2 .32-.72.59-1.43.82-2.13a6.4 6.4 0 0 0 .36-2c0-.65-.19-1.15-.56-1.5A1.85 1.85 0 0 0 19.36.5c-.51 0-.91.15-1.2.47-.29.3-.57.73-.84 1.26a36.24 36.24 0 0 1-3.47 5.53 598.25 598.25 0 0 0-3.5 4.59c-.6.79-1.1 1.57-1.5 2.34a9.9 9.9 0 0 0-.89 2.45c-.2.86-.3 1.83-.3 2.93Z" fill="#43BC63"/>
						</svg>)
			case "3":
				return (<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 29 30" className="w-8 h-8">
							<path d="M.94 20.18c0 1.38.26 2.65.78 3.81a7.02 7.02 0 0 0 2.14 2.77 4.9 4.9 0 0 0 3.09 1.04h2.71a7.92 7.92 0 0 1-2.83-3.34c-.58-1.34-.88-2.8-.88-4.4a11.72 11.72 0 0 1 1.4-5.71c.39-.72.77-1.33 1.15-1.83H6.44a4.3 4.3 0 0 0-2.82 1.03 6.79 6.79 0 0 0-1.96 2.75 10.04 10.04 0 0 0-.72 3.88Zm6.73-.11a8.47 8.47 0 0 0 2.81 6.46 9.66 9.66 0 0 0 3.33 1.9c1.3.46 2.75.69 4.38.69h1.9c.9 0 1.69-.03 2.34-.09A8.27 8.27 0 0 0 24 28.8a3.97 3.97 0 0 0 1.48-.73c.45-.36.67-.86.67-1.53 0-.27-.03-.5-.1-.7a2.2 2.2 0 0 0-.22-.53c-.12-.2-.1-.33.08-.4.43-.18.81-.47 1.12-.86.32-.39.47-.86.47-1.4 0-.64-.16-1.17-.5-1.59-.16-.22-.12-.4.14-.54.3-.18.56-.46.76-.82a2.91 2.91 0 0 0 .13-2.2c-.1-.3-.24-.55-.41-.71-.19-.17-.17-.35.06-.55.2-.18.37-.43.5-.73a2.6 2.6 0 0 0-.12-2.28c-.22-.38-.5-.68-.88-.9a2.28 2.28 0 0 0-1.23-.33H21c-.61 0-1.12-.15-1.5-.44-.39-.3-.58-.72-.58-1.23 0-.47.12-1.02.35-1.66.24-.63.51-1.3.82-2 .32-.72.59-1.43.82-2.13a6.4 6.4 0 0 0 .36-2c0-.65-.19-1.15-.56-1.5A1.85 1.85 0 0 0 19.36.5c-.51 0-.91.15-1.2.47-.29.3-.57.73-.84 1.26a36.24 36.24 0 0 1-3.47 5.53 598.25 598.25 0 0 0-3.5 4.59c-.6.79-1.1 1.57-1.5 2.34a9.9 9.9 0 0 0-.89 2.45c-.2.86-.3 1.83-.3 2.93Z" fill="#43BC63"/>
						</svg>)
		}
	}
	switch (rating) {
		case "1":
			return (<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 29 31" className="transform rotate-180 w-8 h-8">
						<path d="M.62 21.23c0 1.12.17 2.18.51 3.18a9 9 0 0 0 1.41 2.62 6.8 6.8 0 0 0 2.05 1.79 5.2 5.2 0 0 0 2.5.64h4.45c1.93.94 4.05 1.43 6.2 1.42h1.87c.85 0 1.62-.02 2.32-.07a9.74 9.74 0 0 0 1.77-.27c.88-.21 1.57-.6 2.08-1.17a2.88 2.88 0 0 0 .57-3.07c1-.68 1.5-1.6 1.5-2.76a3.2 3.2 0 0 0-.36-1.6 3 3 0 0 0 .78-1.1c.32-.76.37-1.6.14-2.4a2.6 2.6 0 0 0-.36-.86c.46-.6.7-1.34.67-2.1a3.41 3.41 0 0 0-3.35-3.39h-5.06c-.27 0-.48-.06-.64-.18a.56.56 0 0 1-.23-.48 4 4 0 0 1 .35-1.47c.23-.6.5-1.24.8-1.94.3-.7.57-1.43.8-2.16.23-.68.35-1.39.36-2.1 0-.6-.13-1.12-.38-1.56a2.7 2.7 0 0 0-2.5-1.44c-.6 0-1.14.18-1.59.53A5 5 0 0 0 16 3c-.8 1.6-1.73 3.13-2.77 4.59-.52.75-1.12 1.56-1.78 2.43-.67.87-1.43 1.84-2.29 2.91h-2.6c-1.08 0-2.08.37-2.98 1.12a7.74 7.74 0 0 0-2.15 3c-.54 1.25-.8 2.65-.8 4.19l-.01-.01Zm7.46-.03a9.98 9.98 0 0 1 1.03-5.01c.43-.83.93-1.62 1.49-2.37.68-.91 1.43-1.88 2.24-2.92a64.5 64.5 0 0 0 2.45-3.34 31.98 31.98 0 0 0 2.22-3.8c.27-.53.5-.89.7-1.06.21-.18.45-.27.74-.27.33 0 .6.12.82.36.21.22.32.54.32.96 0 .56-.12 1.17-.35 1.85a32.4 32.4 0 0 1-.82 2.05c-.3.7-.57 1.37-.8 2.02a5.4 5.4 0 0 0-.34 1.76 2.1 2.1 0 0 0 .77 1.71c.57.43 1.27.66 1.98.63h4.85c.47 0 .86.17 1.18.5a1.6 1.6 0 0 1 .5 1.2c0 .33-.05.62-.16.87-.1.23-.28.46-.51.68a.66.66 0 0 0-.27.44c0 .17.08.34.2.46.17.22.3.47.4.73.1.24.15.5.15.76a2.04 2.04 0 0 1-.9 1.67.97.97 0 0 0-.34.47c-.06.18-.03.38.08.6.14.22.26.46.36.7.07.23.11.46.11.7 0 .74-.47 1.34-1.4 1.8a.62.62 0 0 0-.31.33c-.05.14-.03.3.06.47.11.24.2.48.28.73a2 2 0 0 1 .06.49c0 .37-.14.68-.4.95-.25.27-.64.48-1.17.61-.4.11-.92.18-1.55.22-.7.04-1.42.06-2.13.06h-1.77a11.8 11.8 0 0 1-5.13-1.04 8.28 8.28 0 0 1-3.43-2.83 7.28 7.28 0 0 1-1.21-4.14Zm-5.77.03a9.4 9.4 0 0 1 .58-3.36c.4-1 .93-1.8 1.58-2.38a3.1 3.1 0 0 1 2.1-.88h1.49a12.1 12.1 0 0 0-1.67 6.56 8.62 8.62 0 0 0 2.87 6.6H7.08c-.85 0-1.63-.3-2.36-.89a6.5 6.5 0 0 1-1.75-2.37c-.44-1-.66-2.09-.66-3.28Z" fill="#000"/>
					</svg>)
		case "2":
			return (<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 29 31" className="transform -rotate-90 w-8 h-8">
						<path d="M.62 21.23c0 1.12.17 2.18.51 3.18a9 9 0 0 0 1.41 2.62 6.8 6.8 0 0 0 2.05 1.79 5.2 5.2 0 0 0 2.5.64h4.45c1.93.94 4.05 1.43 6.2 1.42h1.87c.85 0 1.62-.02 2.32-.07a9.74 9.74 0 0 0 1.77-.27c.88-.21 1.57-.6 2.08-1.17a2.88 2.88 0 0 0 .57-3.07c1-.68 1.5-1.6 1.5-2.76a3.2 3.2 0 0 0-.36-1.6 3 3 0 0 0 .78-1.1c.32-.76.37-1.6.14-2.4a2.6 2.6 0 0 0-.36-.86c.46-.6.7-1.34.67-2.1a3.41 3.41 0 0 0-3.35-3.39h-5.06c-.27 0-.48-.06-.64-.18a.56.56 0 0 1-.23-.48 4 4 0 0 1 .35-1.47c.23-.6.5-1.24.8-1.94.3-.7.57-1.43.8-2.16.23-.68.35-1.39.36-2.1 0-.6-.13-1.12-.38-1.56a2.7 2.7 0 0 0-2.5-1.44c-.6 0-1.14.18-1.59.53A5 5 0 0 0 16 3c-.8 1.6-1.73 3.13-2.77 4.59-.52.75-1.12 1.56-1.78 2.43-.67.87-1.43 1.84-2.29 2.91h-2.6c-1.08 0-2.08.37-2.98 1.12a7.74 7.74 0 0 0-2.15 3c-.54 1.25-.8 2.65-.8 4.19l-.01-.01Zm7.46-.03a9.98 9.98 0 0 1 1.03-5.01c.43-.83.93-1.62 1.49-2.37.68-.91 1.43-1.88 2.24-2.92a64.5 64.5 0 0 0 2.45-3.34 31.98 31.98 0 0 0 2.22-3.8c.27-.53.5-.89.7-1.06.21-.18.45-.27.74-.27.33 0 .6.12.82.36.21.22.32.54.32.96 0 .56-.12 1.17-.35 1.85a32.4 32.4 0 0 1-.82 2.05c-.3.7-.57 1.37-.8 2.02a5.4 5.4 0 0 0-.34 1.76 2.1 2.1 0 0 0 .77 1.71c.57.43 1.27.66 1.98.63h4.85c.47 0 .86.17 1.18.5a1.6 1.6 0 0 1 .5 1.2c0 .33-.05.62-.16.87-.1.23-.28.46-.51.68a.66.66 0 0 0-.27.44c0 .17.08.34.2.46.17.22.3.47.4.73.1.24.15.5.15.76a2.04 2.04 0 0 1-.9 1.67.97.97 0 0 0-.34.47c-.06.18-.03.38.08.6.14.22.26.46.36.7.07.23.11.46.11.7 0 .74-.47 1.34-1.4 1.8a.62.62 0 0 0-.31.33c-.05.14-.03.3.06.47.11.24.2.48.28.73a2 2 0 0 1 .06.49c0 .37-.14.68-.4.95-.25.27-.64.48-1.17.61-.4.11-.92.18-1.55.22-.7.04-1.42.06-2.13.06h-1.77a11.8 11.8 0 0 1-5.13-1.04 8.28 8.28 0 0 1-3.43-2.83 7.28 7.28 0 0 1-1.21-4.14Zm-5.77.03a9.4 9.4 0 0 1 .58-3.36c.4-1 .93-1.8 1.58-2.38a3.1 3.1 0 0 1 2.1-.88h1.49a12.1 12.1 0 0 0-1.67 6.56 8.62 8.62 0 0 0 2.87 6.6H7.08c-.85 0-1.63-.3-2.36-.89a6.5 6.5 0 0 1-1.75-2.37c-.44-1-.66-2.09-.66-3.28Z" fill="#000"/>
					</svg>)
		case "3":
			return (<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 29 31" className="w-8 h-8">
						<path d="M.62 21.23c0 1.12.17 2.18.51 3.18a9 9 0 0 0 1.41 2.62 6.8 6.8 0 0 0 2.05 1.79 5.2 5.2 0 0 0 2.5.64h4.45c1.93.94 4.05 1.43 6.2 1.42h1.87c.85 0 1.62-.02 2.32-.07a9.74 9.74 0 0 0 1.77-.27c.88-.21 1.57-.6 2.08-1.17a2.88 2.88 0 0 0 .57-3.07c1-.68 1.5-1.6 1.5-2.76a3.2 3.2 0 0 0-.36-1.6 3 3 0 0 0 .78-1.1c.32-.76.37-1.6.14-2.4a2.6 2.6 0 0 0-.36-.86c.46-.6.7-1.34.67-2.1a3.41 3.41 0 0 0-3.35-3.39h-5.06c-.27 0-.48-.06-.64-.18a.56.56 0 0 1-.23-.48 4 4 0 0 1 .35-1.47c.23-.6.5-1.24.8-1.94.3-.7.57-1.43.8-2.16.23-.68.35-1.39.36-2.1 0-.6-.13-1.12-.38-1.56a2.7 2.7 0 0 0-2.5-1.44c-.6 0-1.14.18-1.59.53A5 5 0 0 0 16 3c-.8 1.6-1.73 3.13-2.77 4.59-.52.75-1.12 1.56-1.78 2.43-.67.87-1.43 1.84-2.29 2.91h-2.6c-1.08 0-2.08.37-2.98 1.12a7.74 7.74 0 0 0-2.15 3c-.54 1.25-.8 2.65-.8 4.19l-.01-.01Zm7.46-.03a9.98 9.98 0 0 1 1.03-5.01c.43-.83.93-1.62 1.49-2.37.68-.91 1.43-1.88 2.24-2.92a64.5 64.5 0 0 0 2.45-3.34 31.98 31.98 0 0 0 2.22-3.8c.27-.53.5-.89.7-1.06.21-.18.45-.27.74-.27.33 0 .6.12.82.36.21.22.32.54.32.96 0 .56-.12 1.17-.35 1.85a32.4 32.4 0 0 1-.82 2.05c-.3.7-.57 1.37-.8 2.02a5.4 5.4 0 0 0-.34 1.76 2.1 2.1 0 0 0 .77 1.71c.57.43 1.27.66 1.98.63h4.85c.47 0 .86.17 1.18.5a1.6 1.6 0 0 1 .5 1.2c0 .33-.05.62-.16.87-.1.23-.28.46-.51.68a.66.66 0 0 0-.27.44c0 .17.08.34.2.46.17.22.3.47.4.73.1.24.15.5.15.76a2.04 2.04 0 0 1-.9 1.67.97.97 0 0 0-.34.47c-.06.18-.03.38.08.6.14.22.26.46.36.7.07.23.11.46.11.7 0 .74-.47 1.34-1.4 1.8a.62.62 0 0 0-.31.33c-.05.14-.03.3.06.47.11.24.2.48.28.73a2 2 0 0 1 .06.49c0 .37-.14.68-.4.95-.25.27-.64.48-1.17.61-.4.11-.92.18-1.55.22-.7.04-1.42.06-2.13.06h-1.77a11.8 11.8 0 0 1-5.13-1.04 8.28 8.28 0 0 1-3.43-2.83 7.28 7.28 0 0 1-1.21-4.14Zm-5.77.03a9.4 9.4 0 0 1 .58-3.36c.4-1 .93-1.8 1.58-2.38a3.1 3.1 0 0 1 2.1-.88h1.49a12.1 12.1 0 0 0-1.67 6.56 8.62 8.62 0 0 0 2.87 6.6H7.08c-.85 0-1.63-.3-2.36-.89a6.5 6.5 0 0 1-1.75-2.37c-.44-1-.66-2.09-.66-3.28Z" fill="#000"/>
					</svg>)
	}
}

import { getItem } from "../../lib/localStorageHelper"

const getQualityRatings = (offerId: number) => {
	const apiUrl = `${process.env.NODE_ENV === "development" ? "http://localhost:3000" : "https://mensa-radar.de"}/api/getRatings`
	return fetch(apiUrl, {
		method: "POST",
		body: JSON.stringify({
			offerId: offerId,
		})
	})
	.then((res) => res.json())
	.then(data => {
		console.log(data)
		let polishedQualityReviews = {
			1: [],
			2: [],
			3: [],
		}
		data.qualityRatings.forEach((review) => {
			console.log(review)
			polishedQualityReviews[review.rating].push(review)
		})
		return polishedQualityReviews
	}).catch((err) => {
		console.log(err)
	})
}

export const RatingOverview = (
		{
			offerId
		}: {
			offerId: number
		}
	) => {

	const [qualityRatingsState, setQualityRatingsState] = useState<{1: any[], 2: any[], 3: any[]}>({1: [], 2: [], 3: []}) 
	const [userQualityRatingState, setUserQualityRatingState] = useState<number>(0)

	const sessionId = useRef(getItem("sessionId"))
	
	// This currently doesnt fetch the user rating after a reload
	const handleQualityRatingClick = (rating: number) => {
		console.log(`Session ID: ${sessionId.current} | Rating: ${rating}`)
		fetch(`${process.env.NODE_ENV === "development" ? "http://localhost:3000" : "https://mensa-radar.de"}/api/qualityReview`, {
			method: "POST",
			body: JSON.stringify({
				offerId: offerId,
				sessionId: sessionId.current,
				rating: rating,
			})
		})
		
		// Update Quality Rating State
		setUserQualityRatingState(rating)
	}

	useLayoutEffect(() => {
		getQualityRatings(offerId).then(data => data ? setQualityRatingsState(data) : setQualityRatingsState({1: [], 2: [], 3: []}))
	}, [])

	useLayoutEffect(() => {
		// Check if sessionId is in the state
		if (sessionId.current) {
			const userQualityRating = 	qualityRatingsState[1].find((review) => review.userSessionId === sessionId.current) ||
										qualityRatingsState[2].find((review) => review.userSessionId === sessionId.current) ||
										qualityRatingsState[3].find((review) => review.userSessionId === sessionId.current)

			if (userQualityRating) {
				// Setting the local state to the user rating
				setUserQualityRatingState(userQualityRating.rating)

				// Delete the user rating from the qualityRatingsState
				const newQualityRatingsState = {...qualityRatingsState}
				newQualityRatingsState[userQualityRating.rating] = newQualityRatingsState[userQualityRating.rating].filter((review) => review.userSessionId !== sessionId.current)
				setQualityRatingsState(newQualityRatingsState)
			}
		}
	}, [qualityRatingsState])

	return (
		<div className="py-4 px-8">
				<div className="flex justify-between">
					{/* <QualityRatingComponent qualityRatings={qualityRatings} hasUserRating={hasUserRating} userQualityRating={userQualityRating}/>
					<ReviewTagsComponent tagReviews={tagReviews} hasUserRating={hasUserRating} userTagReviews={userTagReviews}/> */}
					{
						Object.keys(qualityRatingsState).map((key) => {
							return (
								<div className="flex" onClick={() => handleQualityRatingClick(parseInt(key))}>
									{ratingSVG(key, -1)} {userQualityRatingState === parseInt(key) ? qualityRatingsState[key].length + 1 : qualityRatingsState[key].length}
								</div>
							)
						})
					}
				</div>
		</div>
	)
}